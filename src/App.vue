<template>
    <!-- Naive UI ÈÖçÁΩÆÊèê‰æõËÄÖ -->
    <n-config-provider :theme="lightTheme">
        <!-- Ê∂àÊÅØÊèêÁ§∫Êèê‰æõËÄÖ -->
        <n-message-provider placement="top-right" container-style="top: 50px;">
            <!-- ÂØπËØùÊ°ÜÊèê‰æõËÄÖ -->
            <n-dialog-provider>
                <div class="app-container">
                    <!-- ==================== Ëá™ÂÆö‰πâÊ†áÈ¢òÊ†è ==================== -->
                    <TitleBar />

                    <!-- ==================== ‰∏ªÂ∫îÁî®Â∏ÉÂ±Ä ==================== -->
                    <div class="app-layout flex">
                        <!-- Â∑¶‰æßÂØºËà™Ê†è -->
                        <aside class="sidebar flex flex-col">
                            <!-- ‰æßËæπÊ†èÂ§¥ÈÉ® -->
                            <div class="sidebar-header">
                                <!-- Logo Âå∫Âüü -->
                                <div class="logo-section flex align-center gap-15">
                                    <div class="logo-icon flex align-center justify-center">
                                        <!-- Â∑•‰ΩúÂä©ÊâãÂõæÊ†á SVG -->
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                            <path
                                                d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            />
                                            <path
                                                d="M8 12L10 14L16 8"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            />
                                        </svg>
                                    </div>
                                    <h1 class="app-title">Â∑•‰ΩúÂä©Êâã</h1>
                                </div>

                                <!-- Áî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
                                <div class="user-info">
                                    <span class="welcome-text">Ê¨¢ËøéÂõûÊù•ÔºÅ</span>
                                </div>
                            </div>

                            <!-- ‰æßËæπÊ†èÂØºËà™ -->
                            <nav class="sidebar-nav flex-1">
                                <!-- ‰∏ªË¶ÅÂäüËÉΩÂå∫Âüü -->
                                <div class="nav-section">
                                    <div class="nav-section-title">‰∏ªË¶ÅÂäüËÉΩ</div>
                                    <ul class="nav-list">
                                        <!-- Êó•/Âë®Êä•ÊÄªÁªì -->
                                        <li
                                            class="nav-item flex align-center gap-15"
                                            :class="{ active: activeTab === 'report' }"
                                            @click="setActiveTab('report')"
                                        >
                                            <div class="nav-icon">üìä</div>
                                            <span class="nav-text">Êó•/Âë®Êä•ÊÄªÁªì</span>
                                        </li>

                                        <!-- È°πÁõÆÁÆ°ÁêÜ -->
                                        <li
                                            class="nav-item flex align-center gap-15"
                                            :class="{ active: activeTab === 'project' }"
                                            @click="setActiveTab('project')"
                                        >
                                            <div class="nav-icon">üìÅ</div>
                                            <span class="nav-text">È°πÁõÆÁÆ°ÁêÜ</span>
                                        </li>

                                        <!-- OAÁ≥ªÁªü -->
                                        <li
                                            class="nav-item flex align-center gap-15"
                                            :class="{ active: activeTab === 'oa' }"
                                            @click="setActiveTab('oa')"
                                        >
                                            <div class="nav-icon">üè¢</div>
                                            <span class="nav-text">OAÁ≥ªÁªü</span>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Á≥ªÁªüËÆæÁΩÆÂå∫Âüü -->
                                <div class="nav-section">
                                    <div class="nav-section-title">Á≥ªÁªüËÆæÁΩÆ</div>
                                    <ul class="nav-list">
                                        <!-- ËÆæÁΩÆÈ°µÈù¢ -->
                                        <li
                                            class="nav-item flex align-center gap-15"
                                            :class="{ active: activeTab === 'settings' }"
                                            @click="setActiveTab('settings')"
                                        >
                                            <div class="nav-icon">‚öôÔ∏è</div>
                                            <span class="nav-text">Âü∫Á°ÄËÆæÁΩÆ</span>
                                        </li>
                                        <!-- ÂÖ≥‰∫éÈ°µÈù¢ -->
                                        <li
                                            class="nav-item flex align-center gap-15"
                                            :class="{ active: activeTab === 'about' }"
                                            @click="setActiveTab('about')"
                                        >
                                            <div class="nav-icon">‚ÑπÔ∏è</div>
                                            <span class="nav-text">ÂÖ≥‰∫é</span>
                                        </li>
                                    </ul>
                                </div>
                            </nav>

                            <!-- Áä∂ÊÄÅ‰ø°ÊÅØÂç°Áâá -->
                            <div class="status-card">
                                <div class="status-header flex align-center justify-between">
                                    <h3>DSÁä∂ÊÄÅ</h3>
                                    <div
                                        class="status-indicator"
                                        :class="{
                                            online: !systemInitializing && balanceInfo?.is_available,
                                            initializing: systemInitializing,
                                        }"
                                    ></div>
                                </div>
                                <!-- Áä∂ÊÄÅ‰ø°ÊÅØÂÜÖÂÆπ -->
                                <div class="status-content">
                                    <!-- ÂàùÂßãÂåñÁä∂ÊÄÅÊèêÁ§∫ -->
                                    <div v-if="systemInitializing" class="initializing-info flex align-center justify-center">
                                        <span class="initializing-text">Á≥ªÁªüÂàùÂßãÂåñ‰∏≠...</span>
                                    </div>
                                    <!-- Ê≠£Â∏∏Áä∂ÊÄÅ‰ø°ÊÅØ -->
                                    <template v-else>
                                        <!-- Ë¥¶Êà∑‰ΩôÈ¢ù‰ø°ÊÅØ -->
                                        <div class="balance-info flex justify-between align-center">
                                            <span class="balance-label">Ë¥¶Êà∑‰ΩôÈ¢ù</span>
                                            <span class="balance-value">Ôø•{{ balanceInfo?.balance_infos[0]?.total_balance || 0 }}</span>
                                        </div>
                                        <div class="balance-info flex justify-between align-center">
                                            <span class="balance-label">‰ªäÊó•Â∑•Êó∂</span>
                                            <span class="balance-value">{{ todayWorkingHours }}h</span>
                                        </div>

                                        <!-- ÁâàÊú¨‰ø°ÊÅØ -->
                                        <div
                                            class="version-info flex align-center gap-5"
                                            @click="handleVersionClick"
                                            :class="{ clickable: hasUpdateAvailable || hasDownloadedUpdate }"
                                        >
                                            <span class="version-text">v{{ appVersion }}</span>
                                            <!-- Ê£ÄÊü•Êõ¥Êñ∞‰∏≠ÁöÑÂä†ËΩΩÊåáÁ§∫Âô® -->
                                            <n-icon v-if="isCheckingUpdate" size="16" class="checking-indicator spinning" color="#666">
                                                <RefreshOutline />
                                            </n-icon>
                                            <!-- Êõ¥Êñ∞ÊèêÁ§∫ÁÆ≠Â§¥ -->
                                            <n-icon v-else-if="hasUpdateAvailable" size="16" class="update-indicator" color="#18a058">
                                                <ArrowUpOutline />
                                            </n-icon>
                                            <!-- Â∑≤‰∏ãËΩΩÊõ¥Êñ∞ÊèêÁ§∫ -->
                                            <n-icon v-else-if="hasDownloadedUpdate" size="16" class="downloaded-indicator" color="#f0a020">
                                                <DownloadOutline />
                                            </n-icon>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </aside>

                        <!-- ==================== ‰∏ªÂÜÖÂÆπÂå∫Âüü ==================== -->
                        <main class="main-content flex-1 flex flex-col">
                            <div class="content-wrapper flex-1 flex flex-col">
                                <!-- ‰∏ªË¶ÅÂÜÖÂÆπÊ†áÁ≠æÈ°µÁªÑ‰ª∂ -->
                                <HomeTabs :active-tab="activeTab" @save="handleCheckDeepSeekBalance" />
                            </div>
                        </main>
                    </div>
                </div>

                <!-- Êõ¥Êñ∞Ê®°ÊÄÅÊ°Ü -->
                <UpdateModal
                    v-model:show="showUpdateModal"
                    :current-version="appVersion"
                    :version-info="latestVersionInfo"
                    :has-downloaded-update="hasDownloadedUpdate"
                    :downloaded-update-path="downloadedUpdatePath"
                    @cancel="handleUpdateCancel"
                    @install-completed="handleInstallCompleted"
                    @message="handleUpdateMessage"
                />
            </n-dialog-provider>
        </n-message-provider>
    </n-config-provider>
</template>

<script setup lang="ts">
// ==================== ÂØºÂÖ•‰æùËµñ ====================

// Naive UI Áõ∏ÂÖ≥ÂØºÂÖ•
import { lightTheme, NConfigProvider, NMessageProvider, NDialogProvider, NIcon, createDiscreteApi } from "naive-ui";
// ÂõæÊ†áÂØºÂÖ•
import { ArrowUpOutline, DownloadOutline, RefreshOutline } from "@vicons/ionicons5";
// ÁªÑ‰ª∂ÂØºÂÖ•
import TitleBar from "./components/TitleBar.vue";
import HomeTabs from "./components/HomeTabs.vue";
import UpdateModal from "./components/UpdateModal.vue";
// API ÂØºÂÖ•
import { checkDeepSeekBalance } from "./api/deepseek";
import { getTodayWorkingHours, OATokenManager } from "./api/oa";
// Êõ¥Êñ∞Áõ∏ÂÖ≥ÂØºÂÖ•ÔºàÂä®ÊÄÅÂä†ËΩΩ‰ª•ÈÅøÂÖçÈòªÂ°ûÂêØÂä®Ôºâ
let updateAPI: any = null;
// Vue Áõ∏ÂÖ≥ÂØºÂÖ•
import { onMounted, ref } from "vue";
// Tauri API ÂØºÂÖ•
import { invoke } from "@tauri-apps/api/core";

// ==================== Á±ªÂûãÂÆö‰πâ ====================

// ‰ΩôÈ¢ù‰ø°ÊÅØÊé•Âè£
interface BalanceInfo {
    currency: string; // Ë¥ßÂ∏ÅÁ±ªÂûã
    total_balance: string; // ÊÄª‰ΩôÈ¢ù
    granted_balance: string; // Ëµ†ÈÄÅ‰ΩôÈ¢ù
    topped_up_balance: string; // ÂÖÖÂÄº‰ΩôÈ¢ù
}

// DeepSeek ‰ΩôÈ¢ùÂìçÂ∫îÊé•Âè£
interface DeepSeekBalance {
    is_available: boolean; // ÊòØÂê¶ÂèØÁî®
    balance_infos: BalanceInfo[]; // ‰ΩôÈ¢ù‰ø°ÊÅØÂàóË°®
}

// ==================== Áä∂ÊÄÅÁÆ°ÁêÜ ====================

// ‰ΩôÈ¢ù‰ø°ÊÅØ
const balanceInfo = ref<DeepSeekBalance>();
// Â∫îÁî®ÁâàÊú¨Âè∑
const appVersion = ref("");
// ÂΩìÂâçÊøÄÊ¥ªÁöÑÊ†áÁ≠æÈ°µ
const activeTab = ref("report");
// Á≥ªÁªüÂàùÂßãÂåñÁä∂ÊÄÅ
const systemInitializing = ref(true);

// ==================== Êõ¥Êñ∞Áõ∏ÂÖ≥Áä∂ÊÄÅ ====================

// Êõ¥Êñ∞Ê£ÄÊµãÁä∂ÊÄÅ
const hasUpdateAvailable = ref(false);
const hasDownloadedUpdate = ref(false);
const latestVersionInfo = ref<any>(null);
const downloadedUpdatePath = ref<string>("");
const showUpdateModal = ref(false);
const updateCheckCompleted = ref(false);
const isCheckingUpdate = ref(false);

// ÂàõÂª∫Ê∂àÊÅØÊèêÁ§∫ÂÆû‰æã
const { message } = createDiscreteApi(["message"], {
    configProviderProps: {
        theme: lightTheme,
    },
    messageProviderProps: {
        placement: "top-right",
        containerStyle: "top: 50px",
    },
});

// DeepSeek Token
const deepseekToken = ref<string>("");

// ‰ªäÊó•Â∑•Êó∂Áõ∏ÂÖ≥Áä∂ÊÄÅ
const todayWorkingHours = ref<string>("0.00");

// ==================== ‰∏öÂä°ÂáΩÊï∞ ====================

// ËÆæÁΩÆÊøÄÊ¥ªÁöÑÊ†áÁ≠æÈ°µ
const setActiveTab = (tab: string) => {
    activeTab.value = tab;
};

// Ëé∑ÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑÈÖçÁΩÆ‰ø°ÊÅØ
const getSettings = () => {
    const raw = localStorage.getItem("githelper-settings");
    if (raw) {
        try {
            return JSON.parse(raw);
        } catch (error) {
            // Ëß£ÊûêÂ§±Ë¥•Êó∂ËøîÂõûÁ©∫ÂØπË±°
            console.warn("Ëß£ÊûêËÆæÁΩÆÂ§±Ë¥•:", error);
        }
    }
    return {};
};

// ==================== Êõ¥Êñ∞Ê£ÄÊµãÁõ∏ÂÖ≥ÂáΩÊï∞ ====================

/**
 * Âä®ÊÄÅÂä†ËΩΩÊõ¥Êñ∞API
 */
const loadUpdateAPI = async () => {
    if (!updateAPI) {
        try {
            updateAPI = await import("./api/updater");
            console.log("‚úÖ Êõ¥Êñ∞APIÂä†ËΩΩÊàêÂäü");
        } catch (error) {
            console.error("‚ùå Êõ¥Êñ∞APIÂä†ËΩΩÂ§±Ë¥•:", error);
            return null;
        }
    }
    return updateAPI;
};

/**
 * Ê£ÄÊü•Êõ¥Êñ∞
 */
const checkForAppUpdates = async (showMessages = false) => {
    // Èò≤Ê≠¢ÈáçÂ§çÊ£ÄÊü•
    if (isCheckingUpdate.value) {
        console.log("‚ö†Ô∏è Ê≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞‰∏≠ÔºåË∑≥ËøáÈáçÂ§çËØ∑Ê±Ç");
        return;
    }

    try {
        isCheckingUpdate.value = true;
        console.log("üîç ÂºÄÂßãÊ£ÄÊü•Â∫îÁî®Êõ¥Êñ∞...");

        // Âä®ÊÄÅÂä†ËΩΩÊõ¥Êñ∞API
        const api = await loadUpdateAPI();
        if (!api) {
            console.warn("‚ö†Ô∏è Êõ¥Êñ∞API‰∏çÂèØÁî®ÔºåË∑≥ËøáÊõ¥Êñ∞Ê£ÄÊü•");
            updateCheckCompleted.value = true;
            return;
        }

        const result = await api.checkForUpdates();

        if (result.hasUpdate && result.versionInfo) {
            console.log("‚úÖ ÂèëÁé∞Êñ∞ÁâàÊú¨:", result.versionInfo.version);
            hasUpdateAvailable.value = true;
            latestVersionInfo.value = result.versionInfo;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Áªè‰∏ãËΩΩËøáËøô‰∏™ÁâàÊú¨
            const downloadedPath = await api.getDownloadedUpdatePath(result.versionInfo.version);
            if (downloadedPath) {
                hasDownloadedUpdate.value = true;
                downloadedUpdatePath.value = downloadedPath;
                console.log("üì¶ Â∑≤‰∏ãËΩΩÊõ¥Êñ∞ÂåÖ:", downloadedPath);
            }

            // Â¶ÇÊûúÊòØÊâãÂä®Ê£ÄÊü•ÊàñËÄÖÁ¨¨‰∏ÄÊ¨°ÂêØÂä®Ê£ÄÊü•ÔºåÊòæÁ§∫Êõ¥Êñ∞Ê®°ÊÄÅÊ°Ü
            if (showMessages || !updateCheckCompleted.value) {
                showUpdateModal.value = true;
            }
        } else {
            console.log("‚úÖ ÂΩìÂâçÂ∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨");
            hasUpdateAvailable.value = false;
            latestVersionInfo.value = null;

            // Â¶ÇÊûúÊòØÊâãÂä®Ê£ÄÊü•ÔºåÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            if (showMessages) {
                message.success("ÂΩìÂâçÂ∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨ÔºÅ");
            }
        }

        updateCheckCompleted.value = true;
    } catch (error) {
        console.error("‚ùå Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•:", error);
        updateCheckCompleted.value = true;

        // Â¶ÇÊûúÊòØÊâãÂä®Ê£ÄÊü•ÔºåÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        if (showMessages) {
            message.error("Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï");
        }
    } finally {
        isCheckingUpdate.value = false;
    }
};

/**
 * Â§ÑÁêÜÁâàÊú¨Âè∑ÁÇπÂáª‰∫ã‰ª∂
 */
const handleVersionClick = async () => {
    // Â¶ÇÊûúÊ≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞ÔºåÊòæÁ§∫ÊèêÁ§∫
    if (isCheckingUpdate.value) {
        message.info("Ê≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞ÔºåËØ∑Á®çÂÄô...");
        return;
    }

    // Â¶ÇÊûúÊúâÊõ¥Êñ∞ÊàñÂ∑≤‰∏ãËΩΩÊõ¥Êñ∞ÔºåÊòæÁ§∫Êõ¥Êñ∞Ê®°ÊÄÅÊ°Ü
    if (hasUpdateAvailable.value || hasDownloadedUpdate.value) {
        showUpdateModal.value = true;
        return;
    }

    // ÊâãÂä®Ê£ÄÊü•Êõ¥Êñ∞
    message.info("Ê≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞...");
    await checkForAppUpdates(true); // ‰º†ÂÖ• true Ë°®Á§∫ÊâãÂä®Ê£ÄÊü•Ôºå‰ºöÊòæÁ§∫ÁªìÊûúÊ∂àÊÅØ
};

/**
 * Â§ÑÁêÜÊõ¥Êñ∞ÂèñÊ∂à
 */
const handleUpdateCancel = () => {
    showUpdateModal.value = false;
};

/**
 * Â§ÑÁêÜÂÆâË£ÖÂÆåÊàê
 */
const handleInstallCompleted = () => {
    showUpdateModal.value = false;
    // Â∫îÁî®Â∞ÜÈáçÂêØÔºåËøôÈáåÁöÑ‰ª£Á†ÅÂèØËÉΩ‰∏ç‰ºöÊâßË°å
};

/**
 * Â§ÑÁêÜÊõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÁöÑÊ∂àÊÅØ‰∫ã‰ª∂
 */
const handleUpdateMessage = (type: "success" | "error" | "info" | "warning", content: string) => {
    // ‰ΩøÁî®Áà∂ÁªÑ‰ª∂ÁöÑ message ÂÆû‰æãÊòæÁ§∫Ê∂àÊÅØ
    switch (type) {
        case "success":
            message.success(content);
            break;
        case "error":
            message.error(content);
            break;
        case "info":
            message.info(content);
            break;
        case "warning":
            message.warning(content);
            break;
    }
};

/**
 * Ê∏ÖÁêÜÊóßÁöÑÊõ¥Êñ∞Êñá‰ª∂
 */
const cleanupUpdates = async () => {
    try {
        const api = await loadUpdateAPI();
        if (api) {
            await api.cleanupOldUpdates();
            console.log("üßπ Ê∏ÖÁêÜÊóßÊõ¥Êñ∞Êñá‰ª∂ÂÆåÊàê");
        }
    } catch (error) {
        console.error("‚ùå Ê∏ÖÁêÜÊõ¥Êñ∞Êñá‰ª∂Â§±Ë¥•:", error);
    }
};

// Ê£ÄÊü• DeepSeek Ë¥¶Êà∑‰ΩôÈ¢ù
const handleCheckDeepSeekBalance = async () => {
    try {
        // Ëé∑ÂèñÈÖçÁΩÆ‰∏≠ÁöÑ token
        const settings = getSettings();
        deepseekToken.value = settings.token || "";

        // Â¶ÇÊûúÊ≤°ÊúâtokenÔºåËÆæÁΩÆ‰∏∫‰∏çÂèØÁî®Áä∂ÊÄÅ
        if (!deepseekToken.value) {
            balanceInfo.value = {
                is_available: false,
                balance_infos: [],
            };
            return;
        }

        // Ë∞ÉÁî® API Ê£ÄÊü•‰ΩôÈ¢ù
        const res: DeepSeekBalance = await checkDeepSeekBalance(deepseekToken.value);

        if (res) {
            if (res.is_available) {
                // ‰ΩôÈ¢ùÂÖÖË∂≥ÔºåÊõ¥Êñ∞‰ΩôÈ¢ù‰ø°ÊÅØ
                balanceInfo.value = res;
            } else {
                // ‰ΩôÈ¢ù‰∏çË∂≥ÊèêÁ§∫
                message.error("ÂΩìÂâçË¥¶Êà∑‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄº");
                balanceInfo.value = {
                    is_available: false,
                    balance_infos: res.balance_infos || [],
                };
            }
        }
    } catch (error) {
        // Token Êó†ÊïàÊàñÂÖ∂‰ªñÈîôËØØ
        console.error("DeepSeek‰ΩôÈ¢ùÊ£ÄÊü•Â§±Ë¥•:", error);
        message.error("token Êó†ÊïàÔºåËØ∑ÈáçÊñ∞ÈÖçÁΩÆ");
        balanceInfo.value = {
            is_available: false,
            balance_infos: [],
        };
    }
};

// Ëé∑Âèñ‰ªäÊó•Â∑•Êó∂
const loadTodayWorkingHours = async () => {
    try {
        console.log("ÂºÄÂßãËé∑Âèñ‰ªäÊó•Â∑•Êó∂...");

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩïOAÁ≥ªÁªü
        if (!OATokenManager.isLoggedIn()) {
            console.log("OAÁ≥ªÁªüÊú™ÁôªÂΩïÔºåÊòæÁ§∫ÈªòËÆ§Â∑•Êó∂");
            todayWorkingHours.value = "0.00";
            return;
        }

        const response = await getTodayWorkingHours();

        if (response.code === 200) {
            todayWorkingHours.value = response.data || "0.00";
            console.log("‰ªäÊó•Â∑•Êó∂Ëé∑ÂèñÊàêÂäü:", todayWorkingHours.value);
        } else {
            throw new Error(response.msg || "Ëé∑Âèñ‰ªäÊó•Â∑•Êó∂Â§±Ë¥•");
        }
    } catch (error: any) {
        console.error("Ëé∑Âèñ‰ªäÊó•Â∑•Êó∂Â§±Ë¥•:", error);
        todayWorkingHours.value = "0.00";
    }
};

// Á≥ªÁªüÂêØÂä®Êó∂ÁöÑÂÆåÊï¥Áä∂ÊÄÅÊ£ÄÊü•
const performSystemCheck = async () => {
    try {
        systemInitializing.value = true;
        console.log("ÂºÄÂßãÊâßË°åÁ≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•...");

        // 1. Ëé∑ÂèñÂ∫îÁî®ÁâàÊú¨Âè∑
        appVersion.value = await invoke("get_app_version");
        console.log("Â∫îÁî®ÁâàÊú¨:", appVersion.value);

        // 2. ÊâßË°åÂÅ•Â∫∑Ê£ÄÊü•
        const healthStatus = await invoke("health_check");
        console.log("ÂÅ•Â∫∑Ê£ÄÊü•ÁªìÊûú:", healthStatus);

        // 3. Ê£ÄÊü•DeepSeekË¥¶Êà∑‰ΩôÈ¢ù
        await handleCheckDeepSeekBalance();

        // 4. Ëé∑Âèñ‰ªäÊó•Â∑•Êó∂ÔºàÂ¶ÇÊûúÂ∑≤ÁôªÂΩïOAÁ≥ªÁªüÔºâ
        await loadTodayWorkingHours();

        // 5. Ê∏ÖÁêÜÊóßÁöÑÊõ¥Êñ∞Êñá‰ª∂
        await cleanupUpdates();

        // 6. ÂêØÂä®ÂêéÂè∞Êõ¥Êñ∞Ê£ÄÊü•ÔºàÂª∂ËøüÊâßË°åÔºåÁ°Æ‰øù‰∏çÈòªÂ°û‰∏ªÁ™óÂè£ÊòæÁ§∫Ôºâ
        setTimeout(() => {
            checkForAppUpdates().catch((error) => {
                console.warn("ÂêéÂè∞Êõ¥Êñ∞Ê£ÄÊü•Â§±Ë¥•:", error);
            });
        }, 5000); // Âª∂Ëøü5ÁßíÊâßË°åÔºåÁ°Æ‰øù‰∏ªÁ™óÂè£Â∑≤ÂÆåÂÖ®ÊòæÁ§∫

        // 7. Ê£ÄÊü•Êú¨Âú∞ÈÖçÁΩÆÂÆåÊï¥ÊÄß
        const settings = getSettings();
        const hasGitUser = !!settings.gitUser;
        const hasToken = !!settings.token;
        const hasTemplates = !!(settings.dailyTemplate && settings.weeklyTemplate);

        console.log("ÈÖçÁΩÆÊ£ÄÊü•ÁªìÊûú:", {
            hasGitUser,
            hasToken,
            hasTemplates,
            balanceAvailable: balanceInfo.value?.is_available || false,
        });

        // 8. ÊòæÁ§∫Á≥ªÁªüÁä∂ÊÄÅÊÄªÁªì
        if (!hasGitUser || !hasToken || !hasTemplates) {
            message.warning("Á≥ªÁªüÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÂâçÂæÄËÆæÁΩÆÈ°µÈù¢ÂÆåÂñÑÈÖçÁΩÆ");
        } else if (balanceInfo.value?.is_available) {
            message.success("DSÁä∂ÊÄÅÊ≠£Â∏∏");
        } else {
            message.warning("DeepSeekË¥¶Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•TokenÈÖçÁΩÆ");
        }
    } catch (error) {
        console.error("Á≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•:", error);
        message.error("Á≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Â∫îÁî®ÈÖçÁΩÆ");
    } finally {
        // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÈÉΩË¶ÅÁªìÊùüÂàùÂßãÂåñÁä∂ÊÄÅ
        systemInitializing.value = false;
    }
};

// ==================== ÁªÑ‰ª∂ÁîüÂëΩÂë®Êúü ====================

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÊâßË°åÂàùÂßãÂåñ - Â∫îÁî®ÂêØÂä®ÁöÑÊ†∏ÂøÉÈÄªËæë
onMounted(async () => {
    try {
        console.log("‰∏ªÂ∫îÁî®ÂºÄÂßãÂàùÂßãÂåñ...");

        // Á°Æ‰øùÂêØÂä®ÁîªÈù¢Ëá≥Â∞ëÊòæÁ§∫2ÁßíÔºåÁªôÁî®Êà∑ËâØÂ•ΩÁöÑÂêØÂä®‰ΩìÈ™å
        const startTime = Date.now();
        const minSplashTime = 2000; // ÊúÄÂ∞ëÊòæÁ§∫2ÁßíÔºåÈÅøÂÖçÈó™ÁÉÅ

        // ÊâßË°åÂÆåÊï¥ÁöÑÁ≥ªÁªüÁä∂ÊÄÅÊ£ÄÊü•ÔºàÂåÖÊã¨APIËøûÊé•„ÄÅÁî®Êà∑Áä∂ÊÄÅÁ≠âÔºâ
        await performSystemCheck();

        // ËÆ°ÁÆóÂ∑≤ÁªèËøáÂéªÁöÑÊó∂Èó¥ÔºåÁ°Æ‰øùÂêØÂä®ÁîªÈù¢ÊòæÁ§∫Ë∂≥Â§üÊó∂Èó¥
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, minSplashTime - elapsedTime);

        if (remainingTime > 0) {
            console.log(`Á≠âÂæÖÂêØÂä®ÁîªÈù¢ÊòæÁ§∫ÂÆåÊï¥Êó∂Èó¥ÔºåÂâ©‰Ωô: ${remainingTime}ms`);
            await new Promise((resolve) => setTimeout(resolve, remainingTime));
        }

        // Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÂêéÔºåÂÖ≥Èó≠ÂêØÂä®ÁîªÈù¢Âπ∂ÊòæÁ§∫‰∏ªÁ™óÂè£
        await invoke("close_splashscreen");
        console.log("ÂêØÂä®ÁîªÈù¢Â∑≤ÂÖ≥Èó≠Ôºå‰∏ªÁ™óÂè£Â∑≤ÊòæÁ§∫");
    } catch (error) {
        console.error("Á≥ªÁªüÂàùÂßãÂåñÊàñÂêØÂä®ÁîªÈù¢Â§ÑÁêÜÂ§±Ë¥•:", error);
        // Âç≥‰ΩøÂá∫Èîô‰πüË¶ÅÂ∞ùËØïÂÖ≥Èó≠ÂêØÂä®ÁîªÈù¢ÔºåÁ°Æ‰øùÁî®Êà∑ËÉΩÁúãÂà∞‰∏ªÁïåÈù¢
        try {
            await invoke("close_splashscreen");
        } catch (closeError) {
            console.error("ÂÖ≥Èó≠ÂêØÂä®ÁîªÈù¢Â§±Ë¥•:", closeError);
        }
    }
});
</script>

<style scoped lang="scss">
/* Áé∞‰ª£ÂåñÂ∫îÁî®ÂÆπÂô® - ÂúÜËßíÂÜÖÂÆπÂå∫Âüü */
.app-container {
    width: 100vw;
    height: 100vh;
    background: #f8fafc;
    color: #1e293b;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
}

/* ‰∏ªÂ∫îÁî®Â∏ÉÂ±Ä */
.app-layout {
    height: calc(100vh - 40px); /* ÂáèÂéªÊ†áÈ¢òÊ†èÈ´òÂ∫¶ */
    overflow: hidden;
}

/* Â∑¶‰æßÂØºËà™Ê†è */
.sidebar {
    width: 280px;
    background: #ffffff;
    border-right: 1px solid #e2e8f0;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);

    .sidebar-header {
        padding: 24px 20px;
        border-bottom: 1px solid #f1f5f9;

        .logo-section {
            margin-bottom: 16px;

            .logo-icon {
                width: 32px;
                height: 32px;
                background: linear-gradient(135deg, #10b981, #059669);
                border-radius: 8px;
                color: white;
            }

            .app-title {
                font-size: 20px;
                font-weight: 700;
                color: #0f172a;
                margin: 0;
            }
        }

        .user-info {
            .welcome-text {
                font-size: 14px;
                color: #64748b;
            }
        }
    }

    .sidebar-nav {
        overflow-y: auto;

        .nav-section {
            .nav-section-title {
                font-size: 12px;
                font-weight: 600;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                padding: 12px;
            }

            .nav-list {
                list-style: none;
                margin: 0;
                padding: 0;

                .nav-item {
                    padding: 12px 20px;
                    margin: 0 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-size: 14px;
                    font-weight: 500;
                    color: #475569;

                    .nav-icon {
                        font-size: 16px;
                        width: 20px;
                        text-align: center;
                    }

                    &:hover {
                        background: #f1f5f9;
                        color: #0f172a;
                    }

                    &.active {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
                    }
                }
            }
        }
    }

    .status-card {
        margin: 0 24px 24px;
        padding: 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;

        .status-header {
            margin-bottom: 12px;

            h3 {
                font-size: 14px;
                font-weight: 600;
                color: #0f172a;
                margin: 0;
            }

            .status-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #ef4444;

                &.online {
                    background: #10b981;
                }

                &.initializing {
                    background: #f59e0b;
                    animation: pulse 2s infinite;
                }
            }
        }

        .status-content {
            .balance-info {
                margin-bottom: 8px;

                .balance-label {
                    font-size: 12px;
                    color: #64748b;
                }

                .balance-value {
                    font-size: 14px;
                    font-weight: 600;
                    color: #10b981;
                }
            }

            .version-info {
                cursor: pointer;
                padding: 4px 8px;
                border-radius: 4px;
                transition: all 0.2s ease;

                &.clickable {
                    cursor: pointer;

                    &:hover {
                        background: rgba(255, 255, 255, 0.1);
                        transform: translateY(-1px);
                    }
                }

                .version-text {
                    font-size: 12px;
                    color: #94a3b8;
                    font-family: "Consolas", "Monaco", monospace;
                    font-weight: 500;
                }

                .checking-indicator {
                    animation: spin 1s linear infinite;
                }

                .update-indicator {
                    animation: bounce 1s infinite;
                }

                .downloaded-indicator {
                    animation: pulse 2s infinite;
                }
            }

            .initializing-info {
                padding: 8px 0;

                .initializing-text {
                    font-size: 12px;
                    color: #f59e0b;
                    font-weight: 500;
                }
            }
        }
    }
}

/* ÊóãËΩ¨Âä®Áîª */
@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* ËÑâÂÜ≤Âä®Áîª */
@keyframes pulse {
    0%,
    100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* ÂºπË∑≥Âä®Áîª */
@keyframes bounce {
    0%,
    20%,
    50%,
    80%,
    100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-4px);
    }
    60% {
        transform: translateY(-2px);
    }
}

/* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
.main-content {
    background: #f8fafc;
    overflow: hidden;
    min-height: 0; /* ÈáçË¶ÅÔºöÂÖÅËÆ∏ flex Â≠êÂÖÉÁ¥†Ê≠£Á°ÆÊî∂Áº© */

    .content-wrapper {
        padding: 24px;
        overflow-y: auto;
        min-height: 0; /* ÈáçË¶ÅÔºöÂÖÅËÆ∏ÂÜÖÂÆπÊ≠£Á°ÆÊªöÂä® */

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        &::-webkit-scrollbar {
            width: 6px;
        }

        &::-webkit-scrollbar-track {
            background: transparent;
        }

        &::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;

            &:hover {
                background: #94a3b8;
            }
        }
    }
}
</style>
